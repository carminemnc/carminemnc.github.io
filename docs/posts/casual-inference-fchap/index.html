<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Carmine Minichini">
<meta name="dcterms.date" content="2024-10-28">
<meta name="description" content="Il dilemma dell’uovo e della gallina">

<title>Inferenza causale pt.1</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-BEX0MX4L1P"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-BEX0MX4L1P', { 'anonymize_ip': true});
</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../imgs/carminemnc_w_500x500.png" alt="" class="navbar-logo">
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../posts.html" rel="" target="">
 <span class="menu-text">Posts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html" rel="" target="">
 <span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../notebooks.html" rel="" target="">
 <span class="menu-text">Notebooks</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../resume/carmine_minichini_resume_eng_version.pdf" rel="" target="">
 <span class="menu-text">Resume</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#perchè-linferenza-causale" id="toc-perchè-linferenza-causale" class="nav-link active" data-scroll-target="#perchè-linferenza-causale"><span style="background: linear-gradient(180deg,rgba(255,255,255,0) 50%, rgba(1,132,160,0.5) 50%);">Perchè</span> l’inferenza causale?</a></li>
  <li><a href="#i-dati-che-utilizzeremo" id="toc-i-dati-che-utilizzeremo" class="nav-link" data-scroll-target="#i-dati-che-utilizzeremo">I dati che utilizzeremo:</a></li>
  <li><a href="#notazione" id="toc-notazione" class="nav-link" data-scroll-target="#notazione">1. Notazione</a>
  <ul class="collapse">
  <li><a href="#il-nostro-obiettivo" id="toc-il-nostro-obiettivo" class="nav-link" data-scroll-target="#il-nostro-obiettivo">Il nostro obiettivo</a></li>
  </ul></li>
  <li><a href="#difference-in-means" id="toc-difference-in-means" class="nav-link" data-scroll-target="#difference-in-means">2. Difference in means</a>
  <ul class="collapse">
  <li><a href="#stima-di-tau-in-un-contesto-sperimentale" id="toc-stima-di-tau-in-un-contesto-sperimentale" class="nav-link" data-scroll-target="#stima-di-tau-in-un-contesto-sperimentale">Stima di <span class="math inline">\(\tau\)</span> in un contesto <span style="background: linear-gradient(180deg,rgba(255,255,255,0) 50%, rgba(1,132,160,0.5) 50%);">sperimentale</span></a></li>
  </ul></li>
  <li><a href="#direct-estimator" id="toc-direct-estimator" class="nav-link" data-scroll-target="#direct-estimator">3. <span style="background: linear-gradient(180deg,rgba(255,255,255,0) 50%, rgba(1,132,160,0.5) 50%);">Direct</span> estimator</a></li>
  <li><a href="#ipw-inverse-propensity-weighted-estimator" id="toc-ipw-inverse-propensity-weighted-estimator" class="nav-link" data-scroll-target="#ipw-inverse-propensity-weighted-estimator">4. <span style="background: linear-gradient(180deg,rgba(255,255,255,0) 50%, rgba(1,132,160,0.5) 50%);">IPW</span> (Inverse propensity-weighted estimator)</a>
  <ul class="collapse">
  <li><a href="#lipw" id="toc-lipw" class="nav-link" data-scroll-target="#lipw">L’IPW</a></li>
  </ul></li>
  <li><a href="#aipw-augmented-inverse-propensity-weighted-estimator" id="toc-aipw-augmented-inverse-propensity-weighted-estimator" class="nav-link" data-scroll-target="#aipw-augmented-inverse-propensity-weighted-estimator">5. <span style="background: linear-gradient(180deg,rgba(255,255,255,0) 50%, rgba(1,132,160,0.5) 50%);">AIPW</span> (Augmented inverse propensity-weighted estimator)</a></li>
  <li><a href="#elementi-di-diagnostica" id="toc-elementi-di-diagnostica" class="nav-link" data-scroll-target="#elementi-di-diagnostica">6. Elementi di <span style="background: linear-gradient(180deg,rgba(255,255,255,0) 50%, rgba(1,132,160,0.5) 50%);">diagnostica</span></a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Inferenza causale pt.1</h1>
  <div class="quarto-categories">
    <div class="quarto-category">casual inference</div>
    <div class="quarto-category">R</div>
  </div>
  </div>

<div>
  <div class="description">
    Il dilemma dell’uovo e della gallina
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Carmine Minichini </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 28, 2024</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<style>
  body {
    background-image: url("../../imgs/posts_article_background.png");
    background-size: cover;
    background-position: center;
    background-attachment: fixed;
    background-repeat: no-repeat;
  }
</style>
<section id="perchè-linferenza-causale" class="level2">
<h2 class="anchored" data-anchor-id="perchè-linferenza-causale"><span style="background: linear-gradient(180deg,rgba(255,255,255,0) 50%, rgba(1,132,160,0.5) 50%);">Perchè</span> l’inferenza causale?</h2>
<p><img src="https://timelinecovers.pro/facebook-cover/download/bright-galaxy-milky-way-stars-facebook-cover.jpg" class="img-fluid"></p>
<p><strong>L’inferenza causale</strong> è fondamentale perché ci permette di comprendere le relazioni tra cause ed effetti nei fenomeni che osserviamo. A differenza dell’analisi della semplice associazione tra variabili, <em>l’inferenza causale</em> mira a stabilire relazioni causali, ovvero a identificare l’effetto di una variabile (il <span style="background: linear-gradient(180deg,rgba(255,255,255,0) 50%, rgba(1,132,160,0.5) 50%);">trattamento</span>) sulla variabile di interesse (<span style="background: linear-gradient(180deg,rgba(255,255,255,0) 50%, rgba(1,132,160,0.5) 50%);">l’outcome</span>), tenendo conto di tutte le possibili <em>covariate</em>.</p>
<p>Esempi concreti di applicazione dell’inferenza causale possiamo trovarli in:</p>
<ul>
<li><p><strong>Economia</strong>: Gli economisti utilizzano l’inferenza causale per studiare l’impatto di politiche economiche, come cambiamenti nelle tasse o negli investimenti pubblici, sulla disoccupazione, i redditi e la crescita. Questo permette di valutare l’efficacia delle misure economiche.</p></li>
<li><p><strong>Criminologia</strong>: I ricercatori applicano l’inferenza causale per comprendere i fattori che influenzano la criminalità, come la relazione tra povertà, istruzione e tasso di criminalità. Ciò informa le politiche di prevenzione e contrasto della criminalità.</p></li>
<li><p><strong>Medicina</strong>: La ricerca clinica utilizza l’inferenza causale per stabilire eventuali relazioni tra l’assunzione di farmaci e l’insorgenza di effetti collaterali, al fine di migliorarne la sicurezza.</p></li>
</ul>
</section>
<section id="i-dati-che-utilizzeremo" class="level2">
<h2 class="anchored" data-anchor-id="i-dati-che-utilizzeremo">I dati che utilizzeremo:</h2>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-1_3485e5e77a4c86e120d7c1b19e4295b4">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># causalwiz is a free package for causal inference</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># https://github.com/carminemnc/causalwiz</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(causalwiz)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmtest)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sandwich)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">ctheme</span>(<span class="st">"dark"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-2_5003c9103f8723fa5534e7d89dd8752b">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(welfare_small)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> welfare_small</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Treatment: does the the gov't spend too much on "welfare" (1) or "assistance to the poor" (0)</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>treatment <span class="ot">&lt;-</span> <span class="st">"w"</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Outcome: 1 for 'yes', 0 for 'no'</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>outcome <span class="ot">&lt;-</span> <span class="st">"y"</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Additional covariates</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>covariates <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"polviews"</span>, <span class="st">"income"</span>, <span class="st">"educ"</span>, <span class="st">"marital"</span>, <span class="st">"sex"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>In questo capitolo utilizzeremo una versiona abbreviata di un dataset pubblico fornito da <a href="https://gss.norc.org/content/dam/gss/get-documentation/pdf/reports/project-reports/GSSProject%20report32.pdf">(Smith,2016)</a></p>
<p>Il contesto riguarda un sondaggio in cui agli individui veniva chiesto il loro parere sulla spesa del governo americano per il welfare.</p>
<p>Il trattamento, <span class="math inline">\(W\)</span>, consiste nella formulazione del quesito in due formulazioni diverse:</p>
<ol type="1">
<li>Ad una metà dei partecipanti il quesito veniva posto sul tema <em>“welfare</em>”</li>
<li>All’altra metà dei partecipanti al sondaggio il quesito veniva posto sottoforma di <em>“assistenza ai poveri”</em></li>
</ol>
<p>L’outcome è una variabile binaria <span class="math inline">\(Y_i\)</span> che indica se la risposta è stata positiva o meno. Oltre al trattamento e all’outcome il dataset contiene informazioni demografiche come l’età, l’orientamento politico<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>, il reddito, l’educazione, lo stato civile e il sesso.</p>
</section>
<section id="notazione" class="level2">
<h2 class="anchored" data-anchor-id="notazione">1. Notazione</h2>
<p>Sia <span class="math inline">\((\mathbf{X}_i, W_i, Y_i)\)</span> per l’individuo <span class="math inline">\(i\)</span>, dove:</p>
<ul>
<li><span class="math inline">\(\mathbf{X}_i\)</span> è il vettore di covariate osservate per l’individuo <span class="math inline">\(i\)</span></li>
<li><span class="math inline">\(W_i \in \{0, 1\}\)</span> indica l’assegnazione al trattamento (0 = controllo, 1 = trattamento)</li>
<li><span class="math inline">\(Y_i\)</span> è l’outcome osservato</li>
</ul>
<p>Assumiamo che i dati siano generati in modo indipendente e i.i.d. (identicamente distribuito).</p>
<p>Introduciamo i concetti di <em>potenziali outcomes</em>:</p>
<ul>
<li><span class="math inline">\(Y_i(1)\)</span> è l’outcome potenziale dell’individuo <span class="math inline">\(i\)</span> se fosse stato assegnato al trattamento</li>
<li><span class="math inline">\(Y_i(0)\)</span> è l’outcome potenziale dell’individuo <span class="math inline">\(i\)</span> se fosse stato assegnato al controllo</li>
</ul>
<p>Quindi l’outcome osservato <span class="math inline">\(Y_i\)</span> corrisponde a uno dei due potenziali outcomes:</p>
<p><span id="eq-outcomes"><span class="math display">\[ Y_i \equiv Y_i(W_i) = \begin{cases} Y_i(1) &amp; \text{se } W_i = 1 \\ Y_i(0) &amp; \text{se } W_i = 0 \end{cases}  \tag{1}\]</span></span></p>
<section id="il-nostro-obiettivo" class="level3">
<h3 class="anchored" data-anchor-id="il-nostro-obiettivo">Il nostro obiettivo</h3>
<p>L’obiettivo è stimare l’effetto medio del trattamento (in inglese ATE, <span style="background: linear-gradient(180deg,rgba(255,255,255,0) 50%, rgba(1,132,160,0.5) 50%);">Average treatment effect</span> ):</p>
<p><span id="eq-ate"><span class="math display">\[ \tau = \mathbb{E}[Y_i(1) - Y_i(0)] \tag{2}\]</span></span></p>
<ul>
<li><p>L’ATE fornisce una misura complessiva dell’impatto di un trattamento sulla popolazione target.</p></li>
<li><p>Stimare l’ATE è il primo passo per studiare i meccanismi attraverso cui un trattamento influenza gli outcome.</p></li>
</ul>
<p>La stima dell’ATE è cruciale per valutare l’impatto di interventi, supportare le decisioni di policy, comprendere i meccanismi causali e progettare future ricerche empiriche in modo efficace. È un passaggio fondamentale nell’analisi causale.</p>
<section id="in-un-contesto-sperimentale" class="level4">
<h4 class="anchored" data-anchor-id="in-un-contesto-sperimentale">In un contesto sperimentale…</h4>
<p>In un contesto sperimentale, l’assegnazione al trattamento è indipendente dai potenziali outcomes:</p>
<p><span id="eq-perp-exp"><span class="math display">\[ Y_i(1), Y_i(0) \perp W_i  \tag{3}\]</span></span></p>
<p>In altre parole, non ci sono <strong>covariate</strong> che influenzano sia l’assegnazione al trattamento che l’outcome.</p>
<p>Ciò che ci aspetteremmo in un contesto sperimentale ad esempio è che la distribuzione delle covariate per i due outcomes, <span class="math inline">\(Y_i(0)\)</span> e <span class="math inline">\(Y_i(1)\)</span> siamo simili, come nel seguente esempio:</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-3_88da614231e2e8c4dea12888c79f0242">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(data, <span class="fu">aes</span>(<span class="at">x =</span> age <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="fu">nrow</span>(data), <span class="at">sd =</span> <span class="fl">0.1</span>),</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">y =</span> polviews <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="fu">nrow</span>(data), <span class="at">sd =</span> <span class="fl">0.1</span>))) <span class="sc">+</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">vars</span>(<span class="fu">ifelse</span>(w, <span class="st">'Control'</span>, <span class="st">'Treatment'</span>))</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">'Age'</span>,</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">'Political view'</span>,</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">'Outcome distribution in randomized controlling trial'</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="in-un-contesto-reale" class="level4">
<h4 class="anchored" data-anchor-id="in-un-contesto-reale">In un contesto reale…</h4>
<p>In un contesto reale (o osservazionale) però molto spesso l’esposizione al trattamento è direttamente dipendente dalle covariate.</p>
<p>Nell’esempio presentato qui è chiaramente visibile che:</p>
<ul>
<li><p>La popolazione trattata(o di trattamento) ,<span class="math inline">\(Y_i(1)\)</span> , risulta avere un età più alta e una visione politica più di <span style="background: linear-gradient(180deg,rgba(255,255,255,0) 50%, rgba(1,132,160,0.5) 50%);"><em>destra/conservatrice</em></span></p></li>
<li><p>Mentre la popolazione non trattata (o di controllo), <span class="math inline">\(Y_i(1)\)</span> , risulta essere più giovane e con una visione politica più di <span style="background: linear-gradient(180deg,rgba(255,255,255,0) 50%, rgba(1,132,160,0.5) 50%);"><em>sinistra/liberale</em></span></p></li>
</ul>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-4_38c691b9cbcc5c4e829e971ade7092cc">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># in un contesto reale...</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>data_real <span class="ot">&lt;-</span> data</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># defining the group that will be dropped with some high probability</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>grp <span class="ot">&lt;-</span> ((data_real<span class="sc">$</span>w <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">&amp;</span>  <span class="co"># if treated AND...</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        (</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>            (data_real<span class="sc">$</span>age <span class="sc">&gt;</span> <span class="dv">45</span>) <span class="sc">|</span>     <span class="co"># belongs an older group OR</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>            (data_real<span class="sc">$</span>polviews <span class="sc">&lt;</span> <span class="dv">5</span>)   <span class="co"># more conservative</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        )) <span class="sc">|</span> <span class="co"># OR</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        ((data_real<span class="sc">$</span>w <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">&amp;</span>  <span class="co"># if untreated AND...</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        (</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>            (data_real<span class="sc">$</span>age <span class="sc">&lt;</span> <span class="dv">45</span>) <span class="sc">|</span>     <span class="co"># belongs a younger group OR</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>            (data_real<span class="sc">$</span>polviews <span class="sc">&gt;</span> <span class="dv">4</span>)   <span class="co"># more liberal</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>        )) </span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Individuals in the group above have a smaller chance of being kept in the sample</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>prob.keep <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(grp, .<span class="dv">15</span>, .<span class="dv">85</span>)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>keep.idx <span class="ot">&lt;-</span> <span class="fu">as.logical</span>(<span class="fu">rbinom</span>(<span class="at">n=</span><span class="fu">nrow</span>(data_real), <span class="at">prob=</span>prob.keep, <span class="at">size =</span> <span class="dv">1</span>))</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Dropping</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>data_real <span class="ot">&lt;-</span> data_real[keep.idx,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-5_e5420e03908b1bd0722f4cb925e22a20">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(data_real,</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> age <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="fu">nrow</span>(data_real), <span class="at">sd =</span> <span class="fl">0.1</span>),</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> polviews <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="fu">nrow</span>(data_real), <span class="at">sd =</span> <span class="fl">0.1</span>))) <span class="sc">+</span> </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>, <span class="at">color =</span> <span class="st">'#0085A1'</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span> </span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">vars</span>(<span class="fu">ifelse</span>(w, <span class="st">'Control'</span>, <span class="st">'Treatment'</span>))</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Outcome distribution in a real scenario"</span>,</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Age"</span>,</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Political view"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Questo ci permette di introdurre quelle che sono le ipotesi fondamentali da adottare nel momento in cui non siamo in un contesto sperimentale ma piuttosto in un contesto osservazionale, in cui per poter identificare l’effetto causale del trattamento abbiamo bisogno che le seguenti ipotesi siano valide:</p>
<div class="grid">
<div class="g-col-6">
<p><strong>Ipotesi di confondimento (unconfoundedness):</strong></p>
<p>- Questa ipotesi afferma che, una volta condizionato sulle covariate osservate <span class="math inline">\(X_i\)</span>, l’assegnazione al trattamento <span class="math inline">\(W_i\)</span> è indipendente dai potenziali outcomes <span class="math inline">\(Y_i(1)\)</span> e <span class="math inline">\(Y_i(0)\)</span>.</p>
<p>- In altre parole, tutte le possibili fonti di selezione nel trattamento possono essere spiegate dalle covariate osservate.</p>
<p>- Matematicamente: <span class="math inline">\(Y_i(1), Y_i(0) \perp W_i | X_i\)</span> - Questa ipotesi permette di identificare l’effetto causale del trattamento, altrimenti non osservabile.</p>
</div>
<div class="g-col-6">
<p><strong>Ipotesi di sovrapposizione (overlap):</strong></p>
<p>- Questa ipotesi afferma che per ogni possibile combinazione di valori delle covariate <span class="math inline">\(X_i\)</span>, esiste una probabilità positiva di essere assegnati sia al trattamento che al controllo.</p>
<p>- In altre parole, non ci devono essere regioni del supporto delle covariate in cui tutti gli individui sono sempre trattati o sempre di controllo.</p>
<p>- Matematicamente: <span class="math inline">\(\eta &lt; e(x) &lt; 1 - \eta\)</span> per qualche <span class="math inline">\(\eta &gt; 0\)</span> e per tutti i <span class="math inline">\(x\)</span>, dove <span class="math inline">\(e(x) = \mathbb{P}[W_i = 1 | X_i = x]\)</span> è la propensione al trattamento. - Questa ipotesi garantisce che sia possibile confrontare unità trattate e di controllo con caratteristiche simili.</p>
</div>
</div>
<p>L’ipotesi di confondimento assicura che non ci siano variabili non osservate che influenzano sia l’assegnazione al trattamento che l’outcome. L’ipotesi di sovrapposizione garantisce che ci siano unità di confronto appropriate per ogni individuo trattato.</p>
<p>Queste ipotesi sono cruciali per l’applicabilità di metodi come l’IPW e l’AIPW, discussi nelle sezioni successive.</p>
</section>
</section>
</section>
<section id="difference-in-means" class="level2">
<h2 class="anchored" data-anchor-id="difference-in-means">2. Difference in means</h2>
<p>Lo stimatore della differenza delle medie (difference-in-means) è un semplice stimatore non distorto dell’ATE. L’idea è calcolare la media dei outcomes nel gruppo di trattamento meno la media dei outcomes nel gruppo di controllo:</p>
<p><span id="eq-diff-in-means"><span class="math display">\[
\hat{\tau}_\text{DIFF} = \frac{1}{n_1} \sum_{i: W_i = 1} Y_i - \frac{1}{n_0} \sum_{i: W_i = 0} Y_i
\tag{4}\]</span></span></p>
<p>dove <span class="math inline">\(n_w = |\{i: W_i = w\}|\)</span> è il numero di individui nel gruppo <span class="math inline">\(w\)</span>.</p>
<p>Lo stimatore della differenza delle medie può essere utilizzato solamente nel contesto sperimentale, ovvero quando l’assegnazione al trattamento è casuale e indipendente dai potenziali outcomes.</p>
<p>In questo caso, l’ipotesi di indipendenza tra assegnazione al trattamento e potenziali outcomes cioè l’ipotesi che <span class="math inline">\(Y_i(1), Y_i(0) \perp W_i\)</span> è soddisfatta.</p>
<p>Ciò significa che non ci sono fattori confondenti che influenzano sia l’assegnazione al trattamento che l’outcome.</p>
<p>Sotto questa ipotesi, la differenza tra la media degli outcomes nel gruppo di trattamento e la media degli outcomes nel gruppo di controllo fornisce una stima <span style="background: linear-gradient(180deg,rgba(255,255,255,0) 50%, rgba(1,132,160,0.5) 50%);">non distorta</span> dell’effetto medio del trattamento (ATE).</p>
<p>In contesti osservazionali, invece, sono necessari metodi più avanzati come l’IPW e l’AIPW.</p>
<section id="stima-di-tau-in-un-contesto-sperimentale" class="level3">
<h3 class="anchored" data-anchor-id="stima-di-tau-in-un-contesto-sperimentale">Stima di <span class="math inline">\(\tau\)</span> in un contesto <span style="background: linear-gradient(180deg,rgba(255,255,255,0) 50%, rgba(1,132,160,0.5) 50%);">sperimentale</span></h3>
<p>La media nel gruppo di trattamento:<br>
<span class="math display">\[
\frac{1}{n_1} \sum_{i: W_i = 1} Y_i
\]</span></p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-6_88f06de6748d2cf82cdae7c9ae0f35d4">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> data[,outcome]</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>W <span class="ot">&lt;-</span> data[,treatment]</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">mean</span>(Y[W<span class="sc">==</span><span class="dv">1</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.09211436</code></pre>
</div>
</div>
<p>e calcolando la media nel gruppo di <span style="background: linear-gradient(180deg,rgba(255,255,255,0) 50%, rgba(1,132,160,0.5) 50%);">controllo</span></p>
<p><span class="math display">\[
\frac{1}{n_0} \sum_{i: W_i = 0} Y_i
\]</span></p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-7_c6f94f24cd5c8b09d6e271a7c10e0189">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">mean</span>(Y[W<span class="sc">==</span><span class="dv">0</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.438129</code></pre>
</div>
</div>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-8_d1aa1dcac0ab266d9b7f00ca4d9d5591">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>fmla <span class="ot">&lt;-</span> <span class="fu">formula</span>(<span class="fu">paste0</span>(outcome, <span class="st">'~'</span>, treatment))</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>ols <span class="ot">&lt;-</span> <span class="fu">lm</span>(fmla, <span class="at">data=</span>data)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">coeftest</span>(ols, <span class="at">vcov=</span><span class="fu">vcovHC</span>(ols, <span class="at">type=</span><span class="st">'HC2'</span>))[<span class="dv">2</span>,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>     Estimate    Std. Error       t value      Pr(&gt;|t|) 
 -0.346014670   0.004804239 -72.022788469   0.000000000 </code></pre>
</div>
</div>
<p>Otteniamo chiaramente che</p>
<p><span class="math display">\[
\hat{\tau}_\text{DIFF} = \frac{1}{n_1} \sum_{i: W_i = 1} Y_i - \frac{1}{n_0} \sum_{i: W_i = 0} Y_i = \: \sim -0.34
\]</span></p>
<p>Questo significa che, in media, le persone nel gruppo di trattamento hanno risposto in modo più negativo rispetto al gruppo di controllo<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>.</p>
</section>
</section>
<section id="direct-estimator" class="level2">
<h2 class="anchored" data-anchor-id="direct-estimator">3. <span style="background: linear-gradient(180deg,rgba(255,255,255,0) 50%, rgba(1,132,160,0.5) 50%);">Direct</span> estimator</h2>
<p>Lo stimatore diretto (direct estimation) è un metodo per stimare l’effetto medio del trattamento (ATE) che può essere utilizzato in contesti osservazionali, ovvero quando l’assegnazione al trattamento non è casuale ma dipende dalle covariate osservate <span class="math inline">\(X_i\)</span>.</p>
<p>Questo stimatore sfrutta la seguente scomposizione:</p>
<p><span class="math display">\[ \mathbb{E}[Y_i(1) - Y_i(0)] = \mathbb{E}[\mathbb{E}[Y_i|X_i, W_i=1]] - \mathbb{E}[\mathbb{E}[Y_i|X_i, W_i=0]] \]</span></p>
<p>La procedura per applicare lo stimatore diretto è la seguente:</p>
<ol type="1">
<li>Stimare <span class="math inline">\(\mu(x, w) = \mathbb{E}[Y_i|X_i=x, W_i=w]\)</span> utilizzando metodi di regressione non parametrici.</li>
<li>Predire <span class="math inline">\(\hat{\mu}(X_i, 1)\)</span> e <span class="math inline">\(\hat{\mu}(X_i, 0)\)</span> per ogni osservazione.</li>
<li>Calcolare la media delle differenze predette:</li>
</ol>
<p><span id="eq-direct-estimator"><span class="math display">\[ \hat{\tau}_\text{DM} = \frac{1}{n} \sum_{i=1}^n \left[\hat{\mu}(X_i, 1) - \hat{\mu}(X_i, 0)\right]  \tag{5}\]</span></span></p>
<p>Questo stimatore sfrutta la regressione per ottenere stime più accurate dell’ATE rispetto al semplice difference-in-means visto precedentemente.</p>
<p><strong>Quando usarlo</strong>: Lo stimatore diretto può essere utilizzato nel contesto osservazionale, quando l’ipotesi di confondimento (<span class="math inline">\(Y_i(1), Y_i(0) \perp W_i | X_i\)</span>) è soddisfatta. Ciò significa che tutte le variabili confondenti sono state misurate e incluse nelle covariate <span class="math inline">\(X_i\)</span>.</p>
<p><strong>Quando non usarlo</strong>: Lo stimatore diretto ha alcuni svantaggi:</p>
<ul>
<li>Dipende fortemente dalla corretta specificazione del modello per <span class="math inline">\(\mu(x, w)\)</span>. Se il modello è mal specificato, le stime saranno distorte.</li>
<li>Non gode delle stesse proprietà asintotiche (come l’efficienza) degli stimatori più avanzati come l’AIPW.</li>
</ul>
<p>Pertanto, quando possibile, è preferibile utilizzare metodi come l’AIPW, che sono più robusti alle ipotesi di modellazione.</p>
</section>
<section id="ipw-inverse-propensity-weighted-estimator" class="level2">
<h2 class="anchored" data-anchor-id="ipw-inverse-propensity-weighted-estimator">4. <span style="background: linear-gradient(180deg,rgba(255,255,255,0) 50%, rgba(1,132,160,0.5) 50%);">IPW</span> (Inverse propensity-weighted estimator)</h2>
<section id="supponiamo.." class="level4">
<h4 class="anchored" data-anchor-id="supponiamo..">Supponiamo..</h4>
<p>Supponiamo di voler stimare l’effetto medio di un certo intervento di apprendimento sui voti degli studenti, misurati su una scala da 0 a 100.</p>
<p>Eseguiamo due esperimenti separati in scuole di tipo <strong>A e B</strong>. Supponiamo che i voti tra gli studenti trattati:</p>
<ul>
<li><strong>nella scuola A</strong>, siano approssimativamente distribuiti come <span class="math inline">\(Y_i(1)|A \sim \mathcal{N}(60, 5^2)\)</span></li>
<li><strong>nella scuola B</strong>, siano distribuiti come <span class="math inline">\(Y_i(1)|B \sim \mathcal{N}(70, 5^2)\)</span></li>
</ul>
<p>Il problema è che l’iscrizione al trattamento non è casuale, ma volontaria:</p>
<ul>
<li><strong>Nelle scuole di tipo A, solo il 5% degli studenti si iscrive al trattamento.</strong></li>
<li><strong>Nelle scuole di tipo B, il 40% degli studenti si iscrive al trattamento.</strong></li>
</ul>
<p>Pertanto, se prendessimo la media dei voti degli studenti trattati senza tenere conto dell’appartenenza scolastica, gli studenti della scuola <span class="math inline">\(B\)</span>, che hanno voti medi più alti, sarebbero sovrarappresentati e quindi la nostra stima dei voti degli studenti trattati sarebbe distorta verso l’alto.</p>
<p>Per avere una stima non distorta dell’effetto medio del trattamento, bisogna tenere conto di questa differenza di probabilità di iscrizione tra le due scuole. In questo modo, si può ribilanciare il campione e calcolare una media ponderata dei voti degli studenti trattati che non risenta della diversa composizione dei due gruppi.</p>
</section>
<section id="lipw" class="level3">
<h3 class="anchored" data-anchor-id="lipw">L’IPW</h3>
<p><span id="eq-ipw"><span class="math display">\[ \hat{\tau}_\text{IPW} = \frac{1}{n} \sum_{i=1}^n Y_i \left[ \frac{W_i}{\hat{e}(X_i)} - \frac{(1 - W_i)}{1 - \hat{e}(X_i)} \right]  \tag{6}\]</span></span></p>
<p>L’estimatore inverse propensity-weighted (IPW) è un metodo per stimare l’effetto medio del trattamento (ATE) che può essere utilizzato in contesti osservazionali, ovvero quando l’assegnazione al trattamento non è casuale ma dipende dalle covariate <span class="math inline">\(X_i\)</span>.</p>
<p>L’idea chiave dell’IPW è di utilizzare i pesi inversi della propensione al trattamento per “bilanciare” il confronto tra individui trattati e di controllo.</p>
<p>La procedura per applicare l’IPW è la seguente:</p>
<ol type="1">
<li>Stimare la propensione al trattamento (o propensity score), <span class="math inline">\(e(X_i) = \mathbb{P}[W_i = 1 | X_i]\)</span> , utilizzando un modello di regressione (preferibilmente non parametrico, ad esempio: logistica).</li>
<li>Calcolare i pesi inversamente proporzionali alla propensione stimata:
<ul>
<li>Per gli individui trattati: <span class="math inline">\(\frac{W_i}{\hat{e}(X_i)}\)</span></li>
<li>Per gli individui di controllo: <span class="math inline">\(\frac{(1 - W_i)}{(1 - \hat{e}(X_i))}\)</span></li>
</ul></li>
<li>Calcolare la media ponderata dei outcomes</li>
</ol>
<p><strong>Quando usarlo</strong>: L’IPW può essere utilizzato nel contesto osservazionale, quando sono soddisfatte le ipotesi di confondimento (<span class="math inline">\(Y_i(1), Y_i(0) \perp W_i | X_i\)</span>) e di sovrapposizione (<span class="math inline">\(\eta &lt; e(x) &lt; 1 - \eta\)</span> per qualche <span class="math inline">\(\eta &gt; 0\)</span>).</p>
<p><strong>Vantaggi dell’IPW</strong>:</p>
<ul>
<li><p>È un metodo semplice da implementare.</p></li>
<li><p>È robusto: se il modello per la propensione è correttamente specificato, l’IPW fornisce stime non distorte dell’ATE.</p></li>
</ul>
<p><strong>Svantaggi dell’IPW</strong>:</p>
<ul>
<li>Quando la propensione al trattamento è molto piccola, i pesi diventano molto grandi, rendendo lo stimatore instabile e con alta varianza.</li>
</ul>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-9_cc2f739e485c0f64f299812a30468e64">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">ipw_estimators</span>(</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data_real,</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimation_method =</span> <span class="st">'IPW'</span>,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome =</span> outcome,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">treatment =</span> treatment,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">covariates =</span> covariates,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_specification =</span> <span class="st">'linear'</span>,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">output =</span> <span class="cn">TRUE</span>,</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Generated formula:
 w ~age+polviews+income+educ+marital+sex 

Difference-in-means estimation (benchmark):
      Estimate     Std. Error        t value       Pr(&gt;|t|) 
 -2.913581e-01   8.599054e-03  -3.388257e+01  5.607391e-237 

 IPW estimation:
      Estimate      Std Error        t value       Pr(&gt;|t|) 
 -3.294320e-01   1.320409e-02  -2.494923e+01  9.412179e-127 </code></pre>
</div>
</div>
<ul>
<li>L’IPW non sfrutta appieno l’informazione contenuta nelle covariate per migliorare l’efficienza della stima.</li>
</ul>
<p>Per superare questi svantaggi, nella prossima sezione verrà introdotto un metodo più sofisticato, l’AIPW, che combina i vantaggi dell’IPW e della regressione diretta.</p>
</section>
</section>
<section id="aipw-augmented-inverse-propensity-weighted-estimator" class="level2">
<h2 class="anchored" data-anchor-id="aipw-augmented-inverse-propensity-weighted-estimator">5. <span style="background: linear-gradient(180deg,rgba(255,255,255,0) 50%, rgba(1,132,160,0.5) 50%);">AIPW</span> (Augmented inverse propensity-weighted estimator)</h2>
<p>L’estimatore AIPW è disponibile in contesti con ipotesi di non confondimento e overlapping. La sua formula è la seguente:</p>
<p><span id="eq-aipw"><span class="math display">\[
\begin{equation}\begin{aligned}\hat{\tau}_\mathrm{AIPW} &amp;:= \frac{1}{n} \sum_{i=1}^n \left(\hat{\mu}_{-i}(X_i, 1) - \hat{\mu}_{-i}(X_i, 0)\right) + \\                        &amp;\quad \frac{W_i}{\hat{e}_{-i}(X_i)} (Y_i - \hat{\mu}_{-i}(X_i, 1)) \: - \\                        &amp;\quad \frac{1-W_i}{1-\hat{e}_{-i}(X_i)} (Y_i - \hat{\mu}_{-i}(X_i, 0))\end{aligned}\end{equation}
\tag{7}\]</span></span></p>
<p>Vantaggi dell’estimatore AIPW:</p>
<ol type="1">
<li><strong>Doppia robustezza</strong>: l’estimatore è corretto se almeno uno tra il modello di outcome <span class="math inline">\(\hat{\mu}(X_i, w)\)</span> o il modello di propensity score <span class="math inline">\(\hat{e}(X_i)\)</span> è corretto.</li>
<li><strong>Efficienza</strong>: sotto ipotesi deboli, l’AIPW è asintoticamente efficiente, ovvero ha la minima varianza asintotica tra una classe ampia di stimatori.</li>
<li><strong>Normalità asintotica</strong>: l’AIPW è asintoticamente normale, permettendo un facile calcolo di errori standard e p-value.</li>
</ol>
<p>Rispetto agli altri stimatori visti precedentemente:</p>
<ul>
<li>È più efficiente del difference-in-means anche in contesti sperimentali.</li>
<li>È più robusto del direct estimator e dell’IPW quando i modelli sono mal specificati.</li>
</ul>
<p>Svantaggi:</p>
<ul>
<li>Richiede la stima di due modelli (outcome e propensity score), il che può essere impegnativo in pratica.</li>
<li>Quando i propensity score sono molto vicini a 0 o 1, l’AIPW può avere prestazioni instabili.</li>
</ul>
<p>In sintesi, l’AIPW è uno stimatore raccomandato in contesti osservazionali con ipotesi di non confondimento e overlapping, grazie alla sua doppia robustezza e efficienza asintotica. La sua implementazione può però risultare più complessa rispetto ad altri stimatori.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-10_916700bf238bf31702c7ca50cc422418">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">ipw_estimators</span>(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data_real,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimation_method =</span> <span class="st">'AIPW'</span>,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome =</span> outcome,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">treatment =</span> treatment,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">covariates =</span> covariates,</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_specification =</span> <span class="st">'linear'</span>,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">output =</span> <span class="cn">TRUE</span>,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">target.sample =</span> <span class="st">"control"</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Generated formula:
 w ~age+polviews+income+educ+marital+sex 

Difference-in-means estimation (benchmark):
      Estimate     Std. Error        t value       Pr(&gt;|t|) 
 -2.913581e-01   8.599054e-03  -3.388257e+01  5.607391e-237 

 AIPW estimation:
    Estimate    Std Error      t value     Pr(&gt;|t|) 
 -0.31920790   0.01071585 -29.78839639   0.00000000 </code></pre>
</div>
</div>
</section>
<section id="elementi-di-diagnostica" class="level2">
<h2 class="anchored" data-anchor-id="elementi-di-diagnostica">6. Elementi di <span style="background: linear-gradient(180deg,rgba(255,255,255,0) 50%, rgba(1,132,160,0.5) 50%);">diagnostica</span></h2>
<p>Come abbiamo visto, in contesti osservazionali le distribuzioni delle covariate possono essere molto diverse tra individui trattati e non trattati. Tali discrepanze possono portare a stime distorte dell’ATE. Ci si aspetterebbe che ponderando verso l’alto o verso il basso le osservazioni in base ai pesi di propensione inversi, le loro medie siano simili.</p>
<p>In effetti, dovremmo attenderci anche che le medie delle funzioni di base delle covariate siano simili dopo la ponderazione. Questa proprietà è chiamata equilibrio. Un modo per verificarlo è il seguente:</p>
<p>Data una certa variabile <span class="math inline">\(Z_i\)</span> (ad esempio, una covariata <span class="math inline">\(X_{i1}\)</span>, o un’interazione tra covariate <span class="math inline">\(X_{i1}X_{i2}\)</span>, o un polinomio nelle covariate <span class="math inline">\(X_{i1}^2\)</span>, ecc.), possiamo verificare la differenza media standardizzata assoluta (ASMD) di <span class="math inline">\(Z_i\)</span> tra individui trattati e non trattati nei nostri dati,</p>
<p><span id="eq-asmd"><span class="math display">\[\frac{|\bar{Z}_1 - \bar{Z}_0|}{\sqrt{s_1^2 + s_0^2}} \tag{8}\]</span></span></p>
<p>dove <span class="math inline">\(\bar{Z}_1\)</span> e <span class="math inline">\(\bar{Z}_0\)</span> sono le medie campionarie di <span class="math inline">\(Z_i\)</span>, e <span class="math inline">\(s_1\)</span> e <span class="math inline">\(s_0\)</span> sono le deviazioni standard di <span class="math inline">\(Z_i\)</span> per i due campioni di individui trattati e non trattati. Successivamente, possiamo verificare la stessa quantità per le loro controparti ponderate <span class="math inline">\(Z_i W_i/\hat{e}(X_i)\)</span> e <span class="math inline">\(Z_i (1-W_i)/(1-\hat{e}(X_i))\)</span>.</p>
<p>Se le nostre propensioni sono ben calibrate, l’ASMD per la versione ponderata dovrebbe essere vicina allo zero.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-11_508b2341bb60c9648807fddd64325a38">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">ipw_estimators</span>(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data_real,</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimation_method =</span> <span class="st">'AIPW'</span>,</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome =</span> outcome,</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">treatment =</span> treatment,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">covariates =</span> covariates,</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_specification =</span> <span class="st">'linear'</span>,</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">output =</span> <span class="cn">TRUE</span>,</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">target.sample =</span> <span class="st">"control"</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Generated formula:
 w ~age+polviews+income+educ+marital+sex 

Difference-in-means estimation (benchmark):
      Estimate     Std. Error        t value       Pr(&gt;|t|) 
 -2.913581e-01   8.599054e-03  -3.388257e+01  5.607391e-237 

 AIPW estimation:
    Estimate    Std Error      t value     Pr(&gt;|t|) 
 -0.32002938   0.01084679 -29.50452793   0.00000000 </code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>bal <span class="ot">&lt;-</span> <span class="fu">aipw_balancer</span>(</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  results<span class="sc">$</span>model_spec_matrix,</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  results<span class="sc">$</span>treatment_variable,</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  results<span class="sc">$</span>e_hat</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cov_bal_plot</span>(results<span class="sc">$</span>model_spec_matrix,</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>             bal<span class="sc">$</span>unadjusted_cov,</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>             bal<span class="sc">$</span>adjusted_cov)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>La variabile “Orientamento politico” cattura le opinioni politiche dei partecipanti su una scala ordinale con valori che vanno tipicamente da 1 (estremamente conservatore) a 7 (estremamente liberale). Valori più bassi indicano una visione politica più di destra/conservatrice, mentre valori più alti indicano una visione più di sinistra/liberale.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Possiamo stimare l’ATE attraverso una regressione lineare del tipo:</p>
<p><span class="math display">\[
Y_i = Y_i(0) + W_i(Y_i(1) - Y_i(0))
\]</span><a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Handle positioning of the toggle
      window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
      const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
      for (let i=0; i<annoteTargets.length; i++) {
        const annoteTarget = annoteTargets[i];
        const targetCell = annoteTarget.getAttribute("data-target-cell");
        const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
        const contentFn = () => {
          const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          if (content) {
            const tipContent = content.cloneNode(true);
            tipContent.classList.add("code-annotation-tip-content");
            return tipContent.outerHTML;
          }
        }
        const config = {
          allowHTML: true,
          content: contentFn,
          onShow: (instance) => {
            selectCodeLines(instance.reference);
            instance.reference.classList.add('code-annotation-active');
            window.tippy.hideAll();
          },
          onHide: (instance) => {
            unselectCodeLines();
            instance.reference.classList.remove('code-annotation-active');
          },
          maxWidth: 300,
          delay: [50, 0],
          duration: [200, 0],
          offset: [5, 10],
          arrow: true,
          appendTo: function(el) {
            return el.parentElement.parentElement.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'quarto',
          placement: 'right',
          popperOptions: {
            modifiers: [
            {
              name: 'flip',
              options: {
                flipVariations: false, // true by default
                allowedAutoPlacements: ['right'],
                fallbackPlacements: ['right', 'top', 'top-start', 'top-end'],
              },
            },
            {
              name: 'preventOverflow',
              options: {
                mainAxis: false,
                altAxis: false
              }
            }
            ]        
          }      
        };
        window.tippy(annoteTarget, config); 
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>